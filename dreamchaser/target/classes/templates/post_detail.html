<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="|${post.title} - Tech Log|"></title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body>
<nav class="navbar" th:replace="~{main :: navbar}"></nav>

<div class="main-layout">
    <aside th:replace="~{fragments/_sidebar :: sidebarFragment}"></aside>
    <main class="main-content">
        <div class="container">
            <div class="detail-container" th:object="${post}">
                <div class="detail-header">
                    <div class="detail-category"><a th:href="@{/post/list/by_category(category=*{category.name()})}" th:text="*{category.displayName}"></a></div>
                    <h1 class="detail-title" th:text="*{title}"></h1>
                    <p class="detail-summary" th:text="*{summary}"></p>
                    <div class="detail-rating" th:text="${'â˜…'.repeat(post.starRating)} + ${'â˜†'.repeat(5 - post.starRating)}"></div>
                </div>
                <div class="detail-meta">
                    <span><i data-feather="user"></i> <span th:text="*{author?.nickname}"></span></span>
                    <span><i data-feather="calendar"></i> <span th:text="${#temporals.format(post.createDate, 'yyyy-MM-dd')}"></span></span>
                    <span><i data-feather="eye"></i> <span th:text="*{viewCount}"></span></span>
                </div>
                <div class="detail-image" th:if="*{imageUrl != null and !imageUrl.isEmpty()}"><img th:src="@{|/uploads/*{imageUrl}|}" alt="ëŒ€í‘œ ì´ë¯¸ì§€"></div>
                <div class="pros-cons-grid">
                    <div class="pros-box">
                        <p>ğŸ‘ Pros</p> <div th:each="item : ${post.pros}"> <p class="pre-wrap-text" th:text="${item}"></p>
                    </div>
                    </div>
                    <div class="cons-box">
                        <p>ğŸ‘ Cons</p> <div th:each="item : ${post.cons}"> <p class="pre-wrap-text" th:text="${item}"></p>
                    </div>
                    </div>
                </div>
                <div class="detail-content" th:utext="*{content}"></div>
                <div class="detail-actions">
                    <a sec:authorize="isAuthenticated()" href="javascript:void(0);" th:data-uri="@{|/post/vote/${post.id}|}" class="recommend btn"><i data-feather="heart"></i> ì¶”ì²œ <span th:text="${#lists.size(post.voter)}"></span></a>
                    <a th:href="@{|/post/modify/${post.id}|}" class="btn btn-secondary" sec:authorize="isAuthenticated()" th:if="${post.author?.username == #authentication.name}">ìˆ˜ì •</a>
                    <a href="javascript:void(0);" th:data-uri="@{|/post/delete/${post.id}|}" class="delete btn btn-danger" sec:authorize="isAuthenticated()" th:if="${post.author?.username == #authentication.name or #authorization.expression('hasRole(''ADMIN'')')}">ì‚­ì œ</a>
                </div>
                <hr class="divider">

                <div class="comment-section">
                    <h3 th:text="|ëŒ“ê¸€ (${#lists.size(post.commentList)})|"></h3>
                    <form class="comment-form" th:action="@{|/comment/create/${post.id}|}" method="post" sec:authorize="isAuthenticated()" th:if="${#lists.size(post.commentList) < 50}" th:object="${commentForm}">
                        <textarea name="content" rows="3" placeholder="ê°€ì´ë“œë¼ì¸ì„ ìœ„ë°˜í•œ ê¸€ì€ ê²½ê³ ì—†ì´ ì‚­ì œë©ë‹ˆë‹¤." th:field="*{content}"></textarea>
                        <div th:if="${#fields.hasErrors('content')}" class="alert-danger" th:errors="*{content}"></div>
                        <input type="hidden" name="parentId" th:if="${commentForm != null}" th:value="*{parentId}">
                        <div class="comment-form-actions" style="text-align: right; margin-top: 0.5rem;"><button type="submit" class="btn">ëŒ“ê¸€ ë“±ë¡</button></div>
                    </form>
                    <div class="alert-warning" th:if="${#lists.size(post.commentList) >= 50}">ëŒ“ê¸€ ê°œìˆ˜ê°€ 50ê°œë¥¼ ì´ˆê³¼í•˜ì—¬ ë” ì´ìƒ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>

                    <div th:if="${errorMessage}" class="alert-danger" th:text="${errorMessage}"></div>

                    <hr class="divider" th:if="${!post.commentList.isEmpty()}" style="margin: 2rem 0;">
                    <div class="comment-list">
                        <div th:each="comment : ${post.commentList}" th:if="${comment.parent == null}">
                            <div th:replace="~{fragments/comment_fragment :: commentFragment(comment=${comment})}"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="reply-form-template" style="display: none;">
    <form th:action="@{|/comment/create/${post.id}|}" method="post" class="comment-form reply-form" th:object="${commentForm}">
        <input type="hidden" name="parentId" value="">
        <textarea name="content" rows="3" placeholder="ë‹µê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”." th:field="*{content}"></textarea>
        <div th:if="${#fields.hasErrors('content')}" class="alert-danger" th:errors="*{content}"></div>
        <div class="reply-form-actions">
            <button type="button" class="btn btn-secondary btn-sm" onclick="cancelReply(this)">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-sm">ë“±ë¡</button>
        </div>
    </form>
</div>

<script type='text/javascript'>
    document.addEventListener('click', function(event) {
        const deleteTarget = event.target.closest('.delete');
        if (deleteTarget) {
            if(confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                location.href = deleteTarget.dataset.uri;
            }
        }
        const recommendTarget = event.target.closest('.recommend');
        if (recommendTarget) {
            if(confirm("ì´ ê¸€ì„ ì¶”ì²œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                location.href = recommendTarget.dataset.uri;
            }
        }
    });

    let currentReplyForm = null;
    function showReplyForm(buttonElement, parentId) {
        const formTemplate = document.getElementById('reply-form-template');
        if (!formTemplate) return;
        const newForm = formTemplate.cloneNode(true);
        newForm.style.display = 'block';
        newForm.removeAttribute('id');
        newForm.querySelector('input[name="parentId"]').value = parentId;

        // ë‹µê¸€ í¼ì— ì´ì „ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ë‚¨ì•„ìˆì§€ ì•Šë„ë¡ ì œê±°
        const existingErrorDiv = newForm.querySelector('.alert-danger');
        if (existingErrorDiv) {
            existingErrorDiv.remove();
        }

        if (currentReplyForm && currentReplyForm.parentNode) {
            currentReplyForm.parentNode.removeChild(currentReplyForm);
        }
        const commentThread = buttonElement.closest('.comment-thread, .reply, .comment');
        if (commentThread) {
            commentThread.appendChild(newForm);
        }
        currentReplyForm = newForm;
        newForm.querySelector('textarea[name="content"]').focus(); // ìƒˆë¡œ ìƒì„±ëœ í¼ì˜ textareaì— í¬ì»¤ìŠ¤
    }

    function cancelReply(cancelButton) {
        const formWrapper = cancelButton.closest('.comment-form.reply-form'); // closest()ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •í™•í•œ í¼ ìš”ì†Œ ì°¾ê¸°
        if (formWrapper && formWrapper.parentNode) {
            formWrapper.parentNode.removeChild(formWrapper);
        }
        currentReplyForm = null;
    }

    try {
        feather.replace();
    } catch (e) {
        console.error("Feather Icons failed to load.", e);
    }
</script>

</body>
</html>